---
title: 'Computational Musicology: Tyler, the Evolution'
author: "Thierry Blankenstein"
date: "2/25/2022"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(spotifyr)
library(plotly)
library(compmus)
library(gridExtra)
library(tidymodels)
library(ggdendro)
library(heatmaply)
library(ape)

get_conf_mat <- function(fit) {
  outcome <- .get_tune_outcome_names(fit)
  fit %>% 
    collect_predictions() %>% 
    conf_mat(truth = outcome, estimate = .pred_class)
}  

get_pr <- function(fit) {
  fit %>% 
    conf_mat_resampled() %>% 
    group_by(Prediction) %>% mutate(precision = Freq / sum(Freq)) %>% 
    group_by(Truth) %>% mutate(recall = Freq / sum(Freq)) %>% 
    ungroup() %>% filter(Prediction == Truth) %>% 
    select(class = Prediction, precision, recall)
}

goblin <- get_playlist_audio_features("", "1xgRIVr1i1rXsscqplnFX0")
wolf <- get_playlist_audio_features("", "4YVnmY4fEbjVHhbRJoYNe3")
cb <- get_playlist_audio_features("", "7HsR3skdWjUzb7Lb0bERaj")
fb <- get_playlist_audio_features("", "14flNZHDdXDJDuDCUdU8CA")
igor <- get_playlist_audio_features("", "2COQtB8ji1FT7gRz2GhgVH")
cmifygl <- get_playlist_audio_features("", "6CZM2pQAkID3M3aYzAhc4x")
```

### Which **features** result in the succesful **clustering** of the albums **IGOR** and **Goblin**? 

```{r cluster, echo=FALSE}
total <-
  get_playlist_audio_features("bnfcollection", "4eTwQdG9Xi7RFBl6fAhkci") %>%
  add_audio_analysis() %>%
  mutate(
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  ) %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  mutate_at(vars(pitches, timbre), map, bind_rows) %>%
  unnest(cols = c(pitches, timbre))

total_juice <-
  recipe(
    track.name ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      valence +
      tempo +
      duration +
      c01 + c02 + c03 + c04 + c05 + c06 +
      c07 + c08 + c09 + c10 + c11 + c12,
    data = total
  ) %>%
  step_center(all_predictors()) %>%
  step_scale(all_predictors()) %>% 
  # step_range(all_predictors()) %>% 
  prep(total %>% mutate(track.name = str_trunc(track.name, 20))) %>%
  juice() %>%
  column_to_rownames("track.name")

total_dist <- dist(total_juice, method = "euclidean")

final <-  total_dist %>% 
  hclust(method = "complete") # Try single, average, and complete.



colors = c("purple", "black")
clus4 = c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2,2, 2,2, 2,2, 2,2, 2)
plot(as.phylo(final), type = "fan", tip.color = colors[clus4],
     label.offset = 0.5, cex = 0.5)

```

***

An interesting question within music is always: What causes certain songs on a album to be a apart of that album? What is the coherence of tracks within an album? I tried to analyze this for the albums of IGOR and Goblin, two very conflicting albums on all fronts. I found it interesting to investigate whether the coherence within these albums and the difference between the tracks of differing albums would be great enough so that two separate clusters would form. To investigate this, I created a dendrogram which uses the track level features of timbre, danceability, energy, loudness, speechiness, acousticness, instrumentalness, valence, tempo and duration to see if these clusters would form. The result can be seen on the left with tracks from IGOR shown in black and tracks from Goblin shown in pink.

Interestingly, we do notice that most of the tracks from Goblin are indeed in the same cluster, with the same holding true for the tracks of IGOR. We do notice some outliers: Some tracks of Goblin are deeply rooted in the IGOR cluster, and the, at this point all to familiar, track "EXACTLY WHAT YOU RUN FROM YOU END UP CHASING" residing in its entirely own cluster. Listening to the Goblin tracks that appear in the IGOR cluster, it is not entirely clear why these appear there: They are very repetitive which is in contrast with most tracks in IGOR. Maybe repetitiveness is not picked up by these track-level features. Besides that, it is not surprising that the aforementioned track resides in its own cluster. This reason for this, is the same reason that its an outlier in many other plots: It is very short, with almost no instrumentals. 

All in all, these features used lead to quite successful clustering of the two albums which means they form their own seperate entities. I suspect that this also applies for different pairs of albums and that all albums of Tyler form entities of their own, that can be successfully distinguished using track-level features. Unfortunately, we can not conclude this with certainty as this experiment does not really have external validity. It does given an indication though.


### Introduction

Tyler, the Creator is an American rapper and record producer which has a fascinating artistic evolution. His first few albums were characterized by vulgar lyrics and gritty beats. This caused him some trouble, being accused of homophobia and misogyny. This didn't seem to stop him, as he kept releasing albums every 2 years. These albums do show an interesting evolution. He stepped away from the dark themes known in his earlier albums and started to show a more sensitive side. His instrumentals became more slow and soul-like and his lyrics more happy. I find this contrast very interesting and I wonder if this is represented by the data given by Spotify API. My corpus will therefore be about the evolution of the albums released by Tyler, the Creator. I want to specifically focus on which parameters changed in the evolution of Tyler's discography. The main research question is: What parameters most prominently changed in the albums of Tyler, The Creator over time?

The natural points of comparison will therefore be the albums of Tyler, the Creator. As said, I expect the earlier albums to show more 'dark' instrumentals with more spoken word. I expect that later albums will show more diverse instrumentals and more singing. I am not quite sure if and how this will exactly translate to the different parameters that Spotify can measure, but this will make the corpus more interesting. Besides that, I am unsure if the trend towards more soul-like and instrumental heavy songs will continue with his last album, CALL ME IF YOU GET LOST, as this also contains more rap and trap-like beats and how this will show up in the data.

Luckily, the tracks in my corpus are very representative for the groups I want to compare as they all belong to the groups. I will be comparing the tracks in the albums and the groups I want to compare are the albums. It doesn't get very much more representative than that. Luckily, all his albums are on Spotify so no groups are left out. Besides that, I will exclude leaked songs, which are not on Spotify, from my research. The limitations of my corpus is that my observation of his evolution is subjective and might no be represented in the data. However, this would also be an interesting result.

The discography of Tyler do contain some atypical tracks / albums. As I said, CMIFYGL is an outlier in the evolution of his albums in my opinion. Some tracks in the more soul-like, melancholic albums also contain more heavy-beats and can form outliers in the data. Like the hard-hitting "WHAT'S GOOD" on the breakup album IGOR or "I Ain't Got Time!" on the happy Flower Boy. However, these tracks are still more 'fleshed-out' in my opinion than the tracks on the earlier albums. So it will be interesting to see how these outliers influence the final corpus.

### How did the **valence** of the **different albums** evolve over time?

```{r valence, echo=FALSE}
albums <-
  bind_rows(
    goblin %>% mutate(album = "Goblin"),
    wolf %>% mutate(album = "Wolf"),
    cb %>% mutate(album = "Cherry Bomb"),
    fb %>% mutate(album = "Flower Boy"),
    igor %>% mutate(album = "IGOR"),
    cmifygl %>% mutate(album = "CMIFYGL"),
  )

# get year from date min(strtoi(substr(track.album.release_date, 1, 4)))

data_by_album <- albums %>%
  group_by(album)
  
valence_plot <- ggplot(data_by_album, aes(x = reorder(album, strtoi(substr(track.album.release_date, 1, 4))), y = valence, fill=album)) +
  geom_boxplot() +
  theme_classic() +
  theme(legend.position="none") +
  labs(title="The evolution of valence over the albums.", x="", y="Valence") +
  annotate(
    "text",
    x = 2.4, y = 0.967,
    label = "← Tamale",
    vjust = 1, size = 3, color = "grey40"
  ) +
  annotate(
    "text",
    x = 5.6, y = 0,
    label = "← EWYRFYEUC",
    vjust = 1, size = 3, color = "grey40"
  )

ggplotly(valence_plot)
```

***

The first interesting metric to analyze is valence. This describes the musical positiveness conveyed by a track. This means that high valence songs sound more positive (happy, cheerful, etc) while low valence sound more negative (angry, sad, etc). It will be interesting to see how this metric changes over the albums of Tyler.

We can clearly observe that, when ignoring Wolf, the valence seems to be slightly increasing with each album. Wolf has such a high valence because of the outlier 'Tamale'. This is a song with happy, high energy instrumentals which causes it to have a valence of 0.967. The lyrics however tell a different story. They are very vulgar and do not necessarily have a positive connotation. The album IGOR has a 'song' with a valence of 0 called "EXACTLY WHAT YOU RUN FROM YOU END UP CHASING". This is a very short recording of someone saying "Exactly what you run from, you end up chasing." It does not really have instrumentals beside some chanting. Because this is not really a song, I'm not sure if it should be included in the data. Removing it, however, barely makes a difference. So to conclude, the valence of Tyler seems to be increasing significantly in recent years, especially after 'Cherry Bomb'.

### How does an **old** and a **new hit song** of Tyler compare when it comes to **musical variety**?
```{r chroma, echo=FALSE}
yonkers <-
  get_tidy_audio_analysis("3WQlJpaUUbGtUqAskvGA7c") %>%  # 5TxRUOsGeWeRl3xOML59Ai
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

awsf <-
  get_tidy_audio_analysis("5TxRUOsGeWeRl3xOML59Ai") %>% # 5TxRUOsGeWeRl3xOML59Ai 5hVghJ4KaYES3BFUATCYn0
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

plot1 <- compmus_long_distance(
  yonkers %>% mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  yonkers %>% mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  feature = pitches,
  method = "euclidean"
) %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  ggtitle("Yonkers") +
  labs(x = "Time (s)", y = "") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)

plot2 <- compmus_long_distance(
  awsf %>% mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  awsf %>% mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  feature = pitches,
  method = "euclidean"
) %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  ggtitle("EARFQUAKE") +
  labs(x = "Time (s)", y = "") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)

grid.arrange(plot1, plot2, ncol=2)
```

***

Next, we will look at an old and new hit song of Tyler to see how they compare when plotting the distances of the chroma vectors of the same song but at different times. This plot says something about how points in time compare musically to other points in time within the same song. When two parts are vary similar, the distance becomes lower which is indicated by a dark shade of blue in this plot. When two parts are very different, it is indicated by a shade of green. The diagonal line in both plots is logical; the distance in chroma vectors between the same moments in the song is zero.

This plot can tell us something about repeating patterns and overall similarity within a song, which in turns says something about the musical variety within a song. To say something about the musical evolution of Tyler, I wanted to compare two representative songs from two different ages of Tyler's discography. First off, there is Yonkers: This is a gritty, controversial song released in 2011 which garnered Tyler a lot of attention. Itset the tone for the album in which it is featured, Goblin. Now compare this to EARFQUAKE, released in May 2019. This is Tyler's biggest hit to date with more than 550 million streams on Spotify. It is a song about a breakup, in which Tyler's showcases a varied instrumental.

This is reflected in the two plots, on the left we notice that the plot for Yonkers shows much repetition indicated by the squares with lower distances. Besides that, there is a certain regularity in its distances as indicated by the horizontal and vertical lines which are equally spaced. On the right, we notice the contrary, there is no such order in its distances with high irregularities around the 100 second mark, this is caused by a guest verse. All in all, the plot seems more chaotic.

What we can conclude from this, is that Tyler's songs have become more complex in nature, showing less repetition and overall more variety. If this is the case for all newer songs is not in the scope of this research, however these representative examples do give an indication.


### How does the timbre-based self-similarity matrices compare for an **old** and **new rap song** of Tyler?
```{r timbre, echo=FALSE}
smuckers <-
  get_tidy_audio_analysis("3v6SdZsS8zR6Go257tldbB") %>% # Change URI.
  compmus_align(bars, segments) %>%                     # Change `bars`
  select(bars) %>%                                      #   in all three
  unnest(bars) %>%                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )

wusyaname <-
  get_tidy_audio_analysis("5B0kgjHULYJhAQkK5XsMoC") %>% # Change URI.
  compmus_align(bars, segments) %>%                     # Change `bars`
  select(bars) %>%                                      #   in all three
  unnest(bars) %>%                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )

plot1 <- smuckers %>%
  compmus_self_similarity(timbre, "euclidean") %>% 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  ggtitle("SMUCKERS") +
  labs(x = "Time (s)", y = "")

plot2 <- wusyaname %>%
  compmus_self_similarity(timbre, "euclidean") %>% 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  ggtitle("WUSYANAME") +
  labs(x = "Time (s)", y = "")

grid.arrange(plot1, plot2, ncol=2)
```

***

We will now compare two rap songs of Tyler when it comes to the timbre-based self-similarity matrix. To elaborate, timbre is the attribute of sound which causes us to be able to differentiate between two sounds with the same pitch. The matrix used, says something about how points in time compare when it comes to timbre to other points in time within the same song. Just like in the previous plots, a dark shade of blue means that the timbre-based features are more similar than when the color is a lighter shade of green. My hope is that, using this matrix, we can analyse if Tyler uses a more varied arsenal of sounds in his songs. We will therefore look at the rap songs "SMUCKERS", released in 2015, to "WUSYANAME", release in 2021. 

We can immediately tell from the plot that 4 squares of high similarity form in the "SMUCKERS" subplot. This tells us that within these squares, the song 'sounds' the same. At around the 3 minute mark, the song repeats the basic melody that is played at the beginning of the song with almost no vocals, which explains the vertical and horizontal lines at these times. With "WUSYNAME", there is almost no pattern to be spotted. There are some vague lines which correspond to the moments in the song where the instrumentals are dropped to put focus on a vocal. However, unlike "SMUCKERS", there seems to be no overall pattern.

What we can conclude from this, is that Tyler's songs have gotten more varied when it comes to the use of different sounds. Again, if this is the case for all newer songs is not in the scope of this research, however the hope is that these songs give an indication.


### How did the **loudness** of the **different albums** evolve over time?
```{r loudness, echo=FALSE}
albums <-
  bind_rows(
    goblin %>% mutate(album = "Goblin"),
    wolf %>% mutate(album = "Wolf"),
    cb %>% mutate(album = "Cherry Bomb"),
    fb %>% mutate(album = "Flower Boy"),
    igor %>% mutate(album = "IGOR"),
    cmifygl %>% mutate(album = "CMIFYGL"),
  )

data <- albums %>%
  mutate(date = strtoi(substr(track.album.release_date, 1, 4)))

plot <- ggplot(data, aes(x = date, y = loudness, label = track.name)) +
  geom_smooth() +
  theme_classic() +
  geom_point(aes(color = album)) +
  labs(title="The evolution of loudness over the albums.", x="", y="Loudness (dB)")

ggplotly(plot)
```

***

Next, we will look at the Spotify API track feature of loudness. It is described as the quality of a sound that is the  correlate of physical strength / amplitude, i.e. the 'power' of a sound. When looking at Tyler's discography, it will be interesting to see how this measure has evolved over the different albums. My hope is to say something about the overall energy that is contained within each album.

Looking at the graph, we can conclude that the loudness of the albums over time seems to show a periodic wave-like pattern. With his first album, we can see a very high variance in loudness, with some outliers, and the lowest mean loudness of all albums. We then see an increase in mean loudness until Cherry Bomb, which is not surprising since this album is known for its high energy and hard hitting, rough instrumentals. We then see Tyler taking a step back with Flower Boy, where the spread in loudness as well as the mean seems to be decreasing again. This albums is characterized by instrumentals with a more happy and laid back sound, so this decrease is not surprising. It then rises again with IGOR, which has the same low outlier as found in the valence plot. This track is an outlier for the same reason it is an outlier in the valence plot; this track has almost no instrumentals and is just someone saying a certain sentence. With his last album we see Tyler returning to high energy / loud tracks with a mean which is roughly the same as Cherry Bomb. When listening to the album, one can understand why: It has the same hard hitting beats which early-Tyler is known for.

Overall, the loudness in Tylers albums seems to be increasing again but shows some periodic behavior. Extrapolating, It would therefore be safe to assume that the next album of Tyler has a high chance of being less loud.

### How did the **tempo distributions** of the albums **change**?

```{r tempi, echo=FALSE}
albums <-
  bind_rows(
    goblin %>% mutate(album = "Goblin"),
    wolf %>% mutate(album = "Wolf"),
    cb %>% mutate(album = "Cherry Bomb"),
    fb %>% mutate(album = "Flower Boy"),
    igor %>% mutate(album = "IGOR"),
    cmifygl %>% mutate(album = "CMIFYGL"),
  )

# get year from date min(strtoi(substr(track.album.release_date, 1, 4)))

data_by_time <- albums %>%
  arrange(strtoi(substr(track.album.release_date, 1, 4)))

neworder <- c("Goblin", "Wolf", "Cherry Bomb", "Flower Boy", "IGOR", "CMIFYGL")

library(plyr)  ## or dplyr (transform -> mutate)
new_data <- arrange(transform(data_by_time,
             album=factor(album,levels=neworder)),album)

tempo <- ggplot(new_data, aes(x = tempo, color = album)) +
  geom_histogram(bins = 20) +
  theme_classic() +
  theme(legend.position="none") +
  labs(title="The evolution of the tempo distribution over the albums.", x="Tempo (BPM)", y="Count") +
  facet_wrap(~ album)

ggplotly(tempo)
```

***

Having discussed valence, chroma, timbre and loudness, a logical variable to discuss next is tempo. For this, we will look at the different histograms of tempi for each album. In this plot, we can see how many songs fall within a certain tempo range for each album. With this plot we will try to answer the question: In what way did the distribution of tempi change over the different albums?

From the plot, we can immediately tell that Tyler had a preference to make songs with a tempo of around 80 BPM. However, this preference seems to have disappeared for his latest album, with most songs being around 138 BPM. Also, the strength of this preference has decreased over time with less songs falling within the largest bin. Besides that, we can see that the tempo of the songs on the first four albums of Tyler seem to be more clustered. Again, this disappeared with his latest two albums, where we can see that the tempi are more spread out.

We can, therefore, conclude that the tempo distribution seem to have changed in the sense that it seems to be getting less clustered over time with a less 'central' preference. The reason for this could be that as Tyler got more comfortable making instrumentals, he started experimenting more and more with different tempi. I expect, that for Tyler's next album he will also use a diverse set of tempi as Tyler has been seeing a lot of success with his latest few albums, which coincidentally, have a diverse set of tempi.


### Conclusion
From the research done so far, we can definitely say that the overall valence of the albums is increasing over time. Besides that, the musical variety of the songs seems to show the same behavior. This means that, from a computational musicology sense, that Tyler's music is becoming more happier in tone as well as more varied.

For now, what can we say about the future of Tyler's music? If we would simply extrapolate our data, then we could say that the overall valence and musical variety of Tyler's new album would even be higher. However, it is never that simple. Because, at the end of the day, Tyler will simply create whatever he thinks sounds good at the time, which is influenced by factors which we simply can't measure. It could be very much the case that a higher valence and musical variety is not what Tyler is looking for in his next album. However, we can say that with all the experience that Tyler has acquired in his journey that it will definitely be worth listening to.
